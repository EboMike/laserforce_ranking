{% extends "base.html" %}
{% block title %}Laserball game on {{ game.start_time.strftime("%A, %B %d at %H:%M") }}{% endblock %}


{% block html_head %}

<style>
    .team_box {
        width: 50%;
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        margin: 0.5em;
        margin-left: 5em;
        margin-right: 5em;
    }

    .team {
        display: inline-block;
        height: 35%;
        padding: 1rem;
        margin-top: 2rem;
        margin-bottom: 2rem;
        margin-left: 5em;
        margin-right: 5em;
        border: 0;
        vertical-align: top;

        display: flex;
        flex-direction: column;
        justify-content: space-around;
    }

    table {
        margin: auto;
        padding: 1rem;
        border: 1px solid lightgray;
        border-collapse: collapse;
        width: 100%;
        table-layout: fixed;
    }

    th, td, tr {
        text-align: center;
        border: 1px solid lightgray;
        height: 30px;
    }

    td {
        color: lightgray;
        padding: 2px;
    }

    tr:nth-child(even) {
        background-color: #252525;
    }

    .userlist {
        border-radius: 15px;
        background: #1A1A1A;
        padding: 1rem;
        margin: auto;
        width: 70%;
        height: 120vh;
        margin-top: 20px;
    }

    body {
        height: 130vh;
    }
</style>

<script>
    function compareValues(a, b) {
        return (a>b) ? -1 : (a<b) ? 1 : 0;
      }
      
    function sortTable(table, colnum) {
        let rows = Array.from(table.querySelectorAll("tr"));
        
        rows = rows.slice(1);
        
        let qs = `td:nth-child(${colnum})`;
        
        rows.sort( (r1,r2) => {
            let t1 = r1.querySelector(qs);
            let t2 = r2.querySelector(qs);
        
            return compareValues(parseInt(t1.textContent), parseInt(t2.textContent));
        });
        
        rows.forEach(row => table.appendChild(row));
    }

    function onReady() {
        if ({{ ice_score }} > {{ fire_score }}) {
            document.getElementById("teams").appendChild(document.getElementById("fire_team"));
        }

        sortTable(document.getElementById("fire_table"), 3)
        sortTable(document.getElementById("ice_table"), 3)
    }

    document.addEventListener("DOMContentLoaded", onReady);
</script>

{% endblock %}


{% block content %}

<div>
    <div class="userlist">
        <div style="margin-left: 0; margin-right: 0; text-align: center;">
            <span title="Game Date"><h2 style="font-size: 25px;">Game on {{ game.start_time.strftime("%A, %B %d at %H:%M") }}</h2></span>
            <span title="Replay"><h3><a href="/game/{{ game.id }}/replay">Replay</a></h3></span>
        </div>

        <div style="clear: both;"></div>

        <div id="teams">
            <div id="fire_team" class="team">
                <h2 style="font-size: 20px; color: orangered;">Fire Team: {{ fire_score }}</h2>

                <table id="fire_table">
                    <th><p>Codename</p></th>
                    {% if game.ranked %}
                        <th><p>Current Rating</p></th>
                    {% endif %}
                    <th><p>Goals</p></th>
                    <!--Assists don't exist yet since we have to calculate them manually-->
                    <th><p>Steals</p></th>
                    <th><p>Clears</p></th>
                    <th><p>Passes</p></th>
                    <th><p>Blocks</p></th>
                    <th><p>Started With Ball</p></th>
                    <th><p>Stolen</p></th>
                    <th><p>Blocked</p></th>
                    <th><p>K/D Ratio</p></th>
                    {% for entity in game.entity_starts %}
                        {% if entity.type == "player" and entity.team.index == 0 %}
                            {% set entity_end = EntityEnds.filter(entity=entity)[0] %}
                            {% set laserball_stats = LaserballStats.filter(entity=entity)[0] %}
                            <tr>
                                <td><a href="/player/{{entity.name}}"><p>{{ entity.name }}</p></a></td>
                                {% if entity_end.current_rating_mu and game.ranked %}
                                    <td title="mu: {{ entity_end.current_rating_mu|round(2) }}, sigma: {{ entity_end.current_rating_sigma|round(2) }}">{{ (entity_end.current_rating_mu - 3 * entity_end.current_rating_sigma)|round(2) }}</td>
                                {% endif %}
                                {% if game.ranked %}
                                    <td><p></p></td>
                                {% endif %}
                                <td><p>{{ laserball_stats.goals }}</p></td>
                                <td><p>{{ laserball_stats.steals }}</p></td>
                                <td><p>{{ laserball_stats.clears }}</p></td>
                                <td><p>{{ laserball_stats.passes }}</p></td>
                                <td><p>{{ laserball_stats.blocks }}</p></td>
                                <td><p>{{ laserball_stats.started_with_ball }}</p></td>
                                <td><p>{{ laserball_stats.times_stolen }}</p></td>
                                <td><p>{{ laserball_stats.times_blocked }}</p></td>
                                <td><p>{{ (laserball_stats.blocks/laserball_stats.times_blocked) | round(2) }}</p></td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                </table>
            </div>
            <div id="blue_team" class="team">
                <h2 style="font-size: 20px; color: #0096FF;">Ice Team: {{ ice_score }}</h2>

                <table id="blue_table">
                    <th><p>Codename</p></th>
                    {% if game.ranked %}
                        <th><p>Current Rating</p></th>
                    {% endif %}
                    <th><p>Goals</p></th>
                    <!--Assists don't exist yet since we have to calculate them manually-->
                    <th><p>Steals</p></th>
                    <th><p>Clears</p></th>
                    <th><p>Passes</p></th>
                    <th><p>Blocks</p></th>
                    <th><p>Started With Ball</p></th>
                    <th><p>Stolen</p></th>
                    <th><p>Blocked</p></th>
                    <th><p>K/D Ratio</p></th>
                    {% for entity in game.entity_starts %}
                        {% if entity.type == "player" and entity.team.index == 1 %}
                            {% set entity_end = EntityEnds.filter(entity=entity)[0] %}
                            {% set laserball_stats = LaserballStats.filter(entity=entity)[0] %}
                            <tr>
                                <td><a href="/player/{{entity.name}}"><p>{{ entity.name }}</p></a></td>
                                {% if entity_end.current_rating_mu and game.ranked %}
                                    <td title="mu: {{ entity_end.current_rating_mu|round(2) }}, sigma: {{ entity_end.current_rating_sigma|round(2) }}">{{ (entity_end.current_rating_mu - 3 * entity_end.current_rating_sigma)|round(2) }}</td>
                                {% endif %}
                                {% if game.ranked %}
                                    <td><p></p></td>
                                {% endif %}
                                <td><p>{{ laserball_stats.goals }}</p></td>
                                <td><p>{{ laserball_stats.steals }}</p></td>
                                <td><p>{{ laserball_stats.clears }}</p></td>
                                <td><p>{{ laserball_stats.passes }}</p></td>
                                <td><p>{{ laserball_stats.blocks }}</p></td>
                                <td><p>{{ laserball_stats.started_with_ball }}</p></td>
                                <td><p>{{ laserball_stats.times_stolen }}</p></td>
                                <td><p>{{ laserball_stats.times_blocked }}</p></td>
                                <td><p>{{ (laserball_stats.blocks/laserball_stats.times_blocked) | round(2) }}</p></td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                </table>
            </div>
        </div>
    </div>
</div>

</body>

{% endblock %}